<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up</title>
    <link rel="stylesheet" href="./style.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="wrapper">
      <form id="registerForm">
        <h1>Register</h1>
        <div class="input-box">
          <input type="email" placeholder="Email" id="email" required />
          <i class="bx bxs-user-circle"></i>
        </div>

        <div class="input-box">
          <input type="text" placeholder="Username" id="username" required />
          <i class="bx bxs-user-circle"></i>
        </div>

        <div class="input-box">
          <input type="password" placeholder="Password" id="password" required />
          <i class="bx bxs-lock-alt"></i>
        </div>

        <div class="input-box">
          <input
            type="password"
            placeholder="Confirm Password"
            id="newpass"
            required
          />
          <i class="bx bxs-lock-alt"></i>
        </div>

        <div class="input-box">
          <select id="role" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <button class="btn" id="btn">Register</button>

        <div class="register-link">
          <p>Already have an account? <a href="login.html">Login</a></p>
        </div>
      </form>
    </div>
  </body>
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

    // LƯU Ý QUAN TRỌNG VỀ BẢO MẬT:
    // KHÔNG BAO GIỜ ĐỂ API KEY TRỰC TIẾP TRONG CODE FRONTEND CHO CÁC ỨNG DỤNG THỰC TẾ.
    // Kẻ xấu có thể lấy cắp key và truy cập vào dữ liệu của bạn.
    // Hãy cân nhắc sử dụng backend hoặc các giải pháp bảo mật của Firebase như App Check.
    const firebaseConfig = {
      apiKey: "AIzaSyC0xBUDjldMphYvaCNLi9EXgRbmGE7MOQQ",
      authDomain: "register-72f9f.firebaseapp.com",
      projectId: "register-72f9f",
      storageBucket: "register-72f9f.appspot.com",
      messagingSenderId: "179655394027",
      appId: "1:179655394027:web:ab5b1606dd4faeb33c34ae",
      measurementId: "G-KRCFFK7KSP",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);

    // Register button event listener
    document
      .querySelector("#registerForm")
      .addEventListener("submit", register);

    function register(event) {
      event.preventDefault(); // Ngăn form gửi đi theo cách truyền thống

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const newpass = document.getElementById("newpass").value;
      const username = document.getElementById("username").value;
      const role = document.getElementById("role").value;

      // --- Cải tiến Validation ---
      if (password !== newpass) {
        alert("Mật khẩu và mật khẩu xác nhận không khớp.");
        return;
      }
      if (password.length < 6) {
        alert("Mật khẩu phải có ít nhất 6 ký tự.");
        return;
      }
      if (!username.trim()) {
        alert("Tên người dùng không được để trống.");
        return;
      }

      // Tạo người dùng mới với Firebase Auth
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;

          // --- ĐÃ XÓA MẬT KHẨU KHỎI ĐÂY ---
          // Chỉ lưu những thông tin không nhạy cảm
          const userData = {
            Email: email,
            Username: username,
            Role: role,
            createdAt: new Date().toISOString(), // Thêm thời gian tạo tài khoản
          };

          // Lưu thông tin người dùng vào Realtime Database
          set(ref(database, "Users/" + user.uid), userData)
            .then(() => {
              alert("Đăng ký người dùng thành công!");
              window.location.href = "login.html"; // Chuyển hướng đến trang đăng nhập
            })
            .catch((dbError) => {
              alert("Lỗi khi lưu dữ liệu người dùng: " + dbError.message);
            });
        })
        .catch((error) => {
          // Cung cấp thông báo lỗi rõ ràng hơn
          if (error.code === "auth/email-already-in-use") {
            alert("Email này đã được sử dụng. Vui lòng chọn email khác.");
          } else if (error.code === 'auth/invalid-email') {
            alert('Địa chỉ email không hợp lệ.');
          }
          else {
            alert("Đã xảy ra lỗi khi đăng ký: " + error.message);
          }
        });
    }
  </script>
</html>