<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../Product management/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <header class="sticky">
      <a href="#" class="logo">DanhMobile</a>
      <ul class="navigation">
        <li><a>Dashboard</a></li>
        <li><a href="#table-1">Product Management</a></li>
      </ul>
    </header>

    <section class="banner" id="banner"></section>

    <div class="main">
      <div class="head-section">
        <h2>Product Management</h2>
        <table id="table-1">
          <tr>
            <td>Product Id</td>
            <td><input type="text" id="product-id" /></td>
          </tr>
          <tr>
            <td>Product Name</td>
            <td><input type="text" id="product-name" /></td>
          </tr>
          <tr>
            <td>Product Quantity</td>
            <td><input type="number" id="product-quantity" /></td>
          </tr>
          <tr>
            <td>Product Price</td>
            <td><input type="text" id="product-price" /></td>
          </tr>
        </table>

        <input type="button" value="Reset" id="resetButton" />
        <input type="button" value="Add" id="addButton" />
        <input type="button" value="Update" id="updateButton" disabled />
      </div>

      <table id="table">
        <thead>
          <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import { getDatabase, ref, get, set, remove, child } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

      // --- Cấu hình Firebase ---
      const firebaseConfig = {
        apiKey: "AIzaSyBujIwoE2iCfachjj2GHITya8Yuz5IqRfI",
        authDomain: "sale-web-58c64.firebaseapp.com",
        databaseURL: "https://sale-web-58c64-default-rtdb.firebaseio.com",
        projectId: "sale-web-58c64",
        storageBucket: "sale-web-58c64.appspot.com",
        messagingSenderId: "769764857149",
        appId: "1:769764857149:web:2e72c9e9e33dac508ee154",
        measurementId: "G-E7HGTV4N3L",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase();
      const dbRef = ref(db);

      // --- DOM Elements ---
      const productIdInput = document.getElementById("product-id");
      const productNameInput = document.getElementById("product-name");
      const productQuantityInput = document.getElementById("product-quantity");
      const productPriceInput = document.getElementById("product-price");
      const tableBody = document.querySelector("#table tbody");

      function showAllProducts() {
        get(child(dbRef, "Products")).then((snapshot) => {
            tableBody.innerHTML = ""; // Xóa dữ liệu cũ
            if (snapshot.exists()) {
                const products = snapshot.val();
                for (const productIdKey in products) {
                    const product = products[productIdKey];
                    if (typeof product === 'object' && product.Id) {
                        const row = createProductRow(product.Id, product);
                        tableBody.appendChild(row);
                    }
                }
            } else {
                tableBody.innerHTML = '<tr><td colspan="5">Không có sản phẩm nào.</td></tr>';
            }
        }).catch((error) => {
            console.error("Lỗi tải sản phẩm:", error);
            alert("Không thể tải danh sách sản phẩm.");
        });
      }
      
      function createProductRow(id, productData) {
        const tr = document.createElement("tr");
        tr.setAttribute("id", `product-row-${id}`);
        tr.innerHTML = `
            <td>${id}</td>
            <td>${productData.Name}</td>
            <td>${productData.Price}</td>
            <td>${productData.Quantity}</td>
            <td>
                <button class="edit-btn" data-id="${id}">Sửa</button>
                <button class="delete-btn" data-id="${id}">Xóa</button>
            </td>
        `;
        return tr;
      }
      
      function resetForm() {
        productIdInput.value = "";
        productNameInput.value = "";
        productQuantityInput.value = "";
        productPriceInput.value = "";
        
        document.getElementById("updateButton").disabled = true;
        document.getElementById("addButton").disabled = false;
        productIdInput.readOnly = false;
        productIdInput.focus();
      }

      // --- Tải dữ liệu lần đầu khi trang được mở ---
      document.addEventListener("DOMContentLoaded", showAllProducts);

      // --- Xử lý sự kiện click trên các nút Sửa/Xóa ---
      tableBody.addEventListener('click', function(event) {
        const target = event.target;
        const productId = target.dataset.id;

        if (target.classList.contains('edit-btn')) {
            get(child(dbRef, `Products/Product ${productId}`)).then((snapshot) => {
                if(snapshot.exists()) {
                    const product = snapshot.val();
                    productIdInput.value = product.Id;
                    productNameInput.value = product.Name;
                    productPriceInput.value = product.Price;
                    productQuantityInput.value = product.Quantity;

                    document.getElementById("updateButton").disabled = false;
                    document.getElementById("addButton").disabled = true;
                    productIdInput.readOnly = true;
                }
            });
        }

        if (target.classList.contains('delete-btn')) {
            if (confirm(`Bạn có chắc muốn xóa sản phẩm ID: ${productId} không?`)) {
                remove(ref(db, `Products/Product ${productId}`))
                    .then(() => {
                        alert("Xóa thành công!");
                        document.getElementById(`product-row-${productId}`).remove();
                        resetForm();
                    })
                    .catch((error) => alert("Xóa thất bại: " + error.message));
            }
        }
      });

      // --- Xử lý sự kiện cho các nút Thêm/Sửa/Reset ---
      document.getElementById("addButton").addEventListener("click", () => {
        const id = productIdInput.value.trim();
        const productData = {
            Id: id,
            Name: productNameInput.value.trim(),
            Price: productPriceInput.value.trim(),
            Quantity: productQuantityInput.value.trim(),
        };

        if (!id || !productData.Name || !productData.Price || !productData.Quantity) {
            alert("Vui lòng điền đầy đủ thông tin sản phẩm.");
            return;
        }

        get(child(dbRef, `Products/Product ${id}`)).then(snapshot => {
            if (snapshot.exists()) {
                alert("ID sản phẩm đã tồn tại.");
            } else {
                set(ref(db, `Products/Product ${id}`), productData)
                    .then(() => {
                        alert("Thêm sản phẩm thành công!");
                        const newRow = createProductRow(id, productData);
                        tableBody.appendChild(newRow);
                        resetForm();
                    })
                    .catch((error) => alert("Thêm thất bại: " + error.message));
            }
        });
      });

      document.getElementById("updateButton").addEventListener("click", () => {
        const id = productIdInput.value;
        const productData = {
            Id: id,
            Name: productNameInput.value.trim(),
            Price: productPriceInput.value.trim(),
            Quantity: productQuantityInput.value.trim(),
        };

        set(ref(db, `Products/Product ${id}`), productData)
            .then(() => {
                alert("Cập nhật thành công!");
                const rowToUpdate = document.getElementById(`product-row-${id}`);
                rowToUpdate.cells[1].textContent = productData.Name;
                rowToUpdate.cells[2].textContent = productData.Price;
                rowToUpdate.cells[3].textContent = productData.Quantity;
                resetForm();
            })
            .catch((error) => alert("Cập nhật thất bại: " + error.message));
      });

      //Add sticky header
      const header = document.querySelector("header");
      const sticky = header.offsetTop;

      window.onscroll = function() {
        if (window.pageYOffset > sticky) {
          header.classList.add("sticky");
        } else {
          header.classList.remove("sticky");
        }
      };

      document.getElementById("resetButton").addEventListener("click", resetForm);

    </script>
  </body>
</html>